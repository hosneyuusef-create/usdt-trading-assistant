## سند مرجع الزامات و دستور اجرای پروژه (نسخه 2025-10-22)

این سند تنها مرجع «چه چیزی باید ساخته شود» است و با `marahel.txt` و `global_playbook.md` همسو تدوین شده است. کلیهٔ خروجی‌ها، تست‌ها و تحویل‌ها باید به الزامات زیر پاسخ دهند. هر تغییر در این سند باید در RTM ثبت و به نسخهٔ جدیدی از این سند منتهی شود.

- قبل از شروع هر مرحله، مطالعهٔ `global_playbook.md`، این سند و مرحلهٔ متناظر در `marahel.txt` الزامی است.
- کنترل نسخه از طریق Git انجام می‌شود (شاخه‌های `feature/<Stage-ID>/<short-description>`، Commitهای واضح و تگ‌های baseline مطابق Playbook).

---

### 1) هدف سامانه
ایجاد سامانهٔ مناقصهٔ خرید/فروش USDT در تلگرام، با انتخاب برندهٔ دستی یا خودکار، تسویهٔ مرحله‌ای ریالی/USDT، ثبت ردیابی کامل رخدادها و پشتیبانی از رسیدگی به اختلافات، به‌صورت Native روی زیرساخت Windows.

### 2) نقش‌ها
- **مشتری:** ثبت و مدیریت RFQ (خرید یا فروش)، تأیید برنده، انجام پرداخت/دریافت USDT، بارگذاری رسید و پاسخ به اختلاف.
- **پرووایدر:** دریافت RFQ، ارسال پیشنهاد قیمت/ظرفیت، انجام تسویه به‌موقع، بارگذاری TxID یا رسید و پاسخ به اختلاف.
- **ادمین:** مدیریت پرووایدرها و سیاست‌ها، انتخاب برنده (یا فعال‌سازی انتخاب خودکار)، نظارت بر SLA، رسیدگی به اختلاف، تهیهٔ گزارش‌ها و اعمال اقدامات مانیتورینگ.

### 3) وریفای و دسترسی‌ها
- مشتری باید موبایل یکتا، حداقل یک کارت بانکی و یک آدرس کیف‌پول ثبت‌شده داشته باشد؛ سقف معامله بر اساس سطح وریفای (Basic/Advanced/Premium) محدود می‌شود.
- پرووایدر باید اطلاعات هویتی و مالی معتبر ثبت کند و حداقل امتیاز و وثیقهٔ تعیین‌شده توسط ادمین را نگه دارد.
- ادمین دسترسی کامل به مدیریت کاربران، RFQها، پیشنهادها، سیاست‌ها و گزارش‌ها دارد.

### 4) مفاهیم و جریان‌های اصلی
- **RFQ:** شامل نوع معامله (خرید/فروش)، مقدار USDT، شبکه (TRC20/BEP20/ERC20 و شبکه‌های تصویب‌شده)، مهلت قیمت‌دهی و شرایط خاص (مانند سقف قیمت یا الزام Split).
- **Quote:** پیشنهاد پرووایدر با قیمت واحد، ظرفیت، کارمزد شبکه و توضیح اختیاری.
- **Award:** انتخاب برنده (یا چند برنده برای Partial-Fill) در پایان مهلت؛ می‌تواند دستی یا خودکار باشد.
- **Settlement:** تسویهٔ دو گام (ریال و USDT) با بارگذاری رسید/TxID، کنترل مهلت و مدیریت مابه‌التفاوت.
- **Dispute:** ثبت اختلاف با مدارک (رسید بانکی با کدرهگیری، TxID، اسکرین‌شات زمان‌دار) و پیگیری تا رأی ادمین.

### 5) جریان «خرید USDT»
1. مشتری RFQ خرید را ثبت می‌کند (مقدار، شبکه، سقف قیمت، مهلت).
2. بات تلگرام به پرووایدرهای واجدشرایط اعلان ناشناس می‌فرستد.
3. پرووایدرها تا پایان مهلت Quote ارسال می‌کنند.
4. پس از پایان مهلت، پیشنهادها برای ادمین نمایش داده می‌شود و موتور خودکار قیمت مؤثر را محاسبه می‌کند.
5. برنده (یا برندگان) انتخاب و اعلان می‌شود.
6. مشتری مبلغ ریالی را به کارت اعلام‌شده واریز و رسید را بارگذاری می‌کند.
7. پس از تأیید، پرووایدر انتقال USDT را انجام و TxID/رسید را ثبت می‌کند.
8. در صورت تأخیر یا اختلاف، Escalation به Dispute فعال می‌شود؛ رأی ادمین ثبت و ابلاغ می‌گردد.

### 6) جریان «فروش USDT»
مطابق جریان خرید، با این تفاوت که ترتیب تسویه (USDT اول یا ریال اول) بر اساس سیاست ادمین مشخص شده و باید در تنظیمات سیستم قابل تغییر باشد. تمدید مهلت، بارگذاری مدارک و Escalation مشابه خرید است.

### 7) قوانین مناقصه
- **مهلت قیمت‌دهی:** مقدار پیش‌فرض ۱۰ دقیقه است و توسط ادمین تنظیم می‌شود.
- **حداقل پیشنهاد معتبر:** قابل تنظیم و باید در قرارداد API و کنترل‌ها لحاظ شود.
- **تمدید مهلت:** هر RFQ می‌تواند یک‌بار در صورت کمبود پیشنهاد تمدید شود.
- **پشتیبانی Partial-Fill:** امکان تقسیم سفارش بین چند پرووایدر فراهم باشد و هر بخش جریان تسویه مستقل داشته باشد.

### 8) انتخاب برنده و رتبه‌بندی
- انتخاب دستی ادمین باید دلیل و در صورت نیاز ممیزی ثانویه داشته باشد.
- انتخاب خودکار بر اساس کمترین قیمت مؤثر است؛ در صورت تساوی، معیارهای پشتیبان (امتیاز پرووایدر، نرخ موفقیت، سرعت) اعمال می‌شود.
- هر Award باید در Logs رویدادهای خود (actor، زمان، دلیل) را ثبت کند.

### 9) محرمانگی و تبادل اطلاعات
- قبل از Award اطلاعات شخصی یا مالی طرفین افشا نمی‌شود.
- پس از Award، سیستم تنها اطلاعات لازم را به هر طرف می‌دهد (کارت بانکی با Mask در اعلان‌ها، اطلاعات کامل در پیام خصوصی پس از تأیید).
- تمامی پیام‌ها، اعلان‌ها و Logs باید دارای Trace ID و قابل ممیزی باشند.

### 10) تسویه و SLAها
- هر Award شامل دو گام است: پرداخت ریال و انتقال USDT. ترتیب و مهلت (پیش‌فرض ۱۵+۱۵ دقیقه) در تنظیمات قابل تغییر است.
- عدم بارگذاری رسید یا تأخیر بیش از مهلت → Escalation و ثبت در Dispute.
- مابه‌التفاوت باید محاسبه و ذخیره شود (برای اختلاف‌های آتی).

### 11) اختلاف و رأی ادمین
- ثبت اختلاف باید مدارک طرفین را در بازهٔ ۳۰ دقیقه دریافت کند.
- ادمین موظف است ظرف حداکثر ۴ ساعت رأی نهایی را صادر کند.
- تمامی تصمیم‌ها باید با ذکر دلیل، وضعیت قبلی و مدارک در Event Log ثبت شود.

### 12) پیام‌ها و اعلان‌ها
- متن اعلان‌ها باید شامل اطلاعات اصلی (شناسه، نوع، مقدار، مهلت) و دیسکلِیمر Non-custodial باشد: «⚠️ این سامانه تأیید بانکی/بلاک‌چین انجام نمی‌دهد؛ صحت پرداخت/انتقال بر عهدهٔ طرفین است.»
- اعلان‌های نمونه:
  - «درخواست جدید #4821 | نوع: خرید | مقدار: 100 USDT | شبکه: TRC20 | مهلت: 10 دقیقه. لطفاً قیمت و ظرفیت را اعلام کنید.»
  - «پیشنهاد شما برای #4821 ثبت شد: قیمت 82,400 تومان/USDT | ظرفیت 100.»
  - «مهلت #4821 تمام شد. 5 پیشنهاد دریافت شد. آمادهٔ انتخاب برنده.»
  - «شما برندهٔ #4821 هستید. لطفاً طبق دستورالعمل، پرداخت/انتقال را در زمان مقرر انجام دهید.»
  - «برای #4821 مبلغ ریالی را به کارت اعلام‌شده واریز کنید و رسید را بارگذاری کنید.»
  - «برای #4821 اختلاف ثبت شد. لطفاً ظرف 30 دقیقه مستندات را ارسال کنید.»
- پیام‌ها باید در `artefacts/message_templates/` با کنترل نسخه نگه‌داری شوند.

### 13) امتیازدهی و محدودیت‌ها
- **پرووایدر:** امتیاز بر اساس نرخ انجام موفق، زمان تسویه، تعداد اخطارها و اختلاف‌ها محاسبه می‌شود؛ امتیاز زیر 60 دسترسی به سفارش‌های بزرگ را محدود می‌کند.
- **مشتری:** امتیاز بر اساس پایبندی به پرداخت و عدم لغوهای بی‌مورد.
- سقف معاملات با توجه به سطح وریفای تعیین‌شده در مرحله 10: Basic=1,000,000 تومان، Advanced=10,000,000، Premium=100,000,000 (قابل تغییر توسط ادمین).

### 14) گزارش‌ها و مانیتورینگ
- گزارش‌های ادمین شامل: تعداد RFQها، میانگین زمان انتخاب برنده، درصد RFQهای دارای ≥3 پیشنهاد، نرخ انجام موفق، زمان تسویه کامل، تعداد اختلاف‌ها و نتایج، عملکرد پرووایدرها، حجم معاملات به تفکیک شبکه، نرخ نقض SLA و شاخص‌های تلمتری.
- تلمتری‌ها باید حداقل شامل `notification_latency_p95`, `notification_failure_rate`, `dispute_escalation_rate` باشد و در داشبورد مانیتور شود (Stage 19 و 23).

### 15) تنظیمات قابل تغییر توسط ادمین
- مهلت قیمت‌دهی، حداقل پیشنهادهای معتبر، وزن‌های انتخاب خودکار، ترتیب تسویه، حداقل تأیید بلاک‌چین، لیست شبکه‌های مجاز، حداقل امتیاز/وثیقهٔ پرووایدر، الگوهای پیام.
- تنظیمات باید نسخه‌دار بوده و قابلیت بازگشت داشته باشند (Stage 22).

### 16) وضعیت‌های سفارش و Partial-Fill
- وضعیت‌های اصلی: Draft → دریافت قیمت → پایان مهلت → Awarded → تسویه → Settled.
- شاخه‌های جانبی: بدون پیشنهاد، لغو قبل از Award، Partial-Fill (هر بخش با وضعیت مستقل)، اختلاف، لغو Award و انتخاب بعدی.
- Aggregate وضعیت سفارش باید بر اساس وضعیت بخش‌ها محاسبه و ثبت شود (Stage 17).

### 17) قوانین شفاف برای کاربران
- قوانین SLA، پیامد تأخیر، معیار انتخاب برنده، مدارک قابل قبول، نحوهٔ امتیازدهی، سیاست حریم خصوصی باید در رابط کاربری یا بخش راهنما قابل مشاهده باشد.

### 18) MVP با کمترین پیچیدگی
- پشتیبانی از حداقل یک شبکه (TRC20) و یک حالت تسویه.  
- انتخاب خودکار ساده بر اساس قیمت مؤثر.  
- تسویهٔ دومرحله‌ای ثابت (۱۵+۱۵ دقیقه).  
- گزارش‌های پایه و امتیازدهی ساده.  
- سناریوهای اختلاف مشخص با مهلت ثبت مدارک.

### 19) محدودیت‌های فنی
- اجرا باید Native روی Windows Server 2019+، بدون Docker.
- استفاده از Git و شاخه‌های مجزا الزامی است؛ تگ baseline پس از هر مرحله در `docs/change_control_and_revert.md` تعریف شده است.
- تلمتری و Logs باید ساختاریافته و ممیزی‌پذیر باشند.

---

### یادداشت پایانی
این سند همراه با RTM و Playbook، سه بال اصلی مدیریت پروژه هستند. هر مرحله از `marahel.txt` باید ورودی‌ها، خروجی‌های ملموس، معیارهای پذیرش، تست‌ها و فرضیات را با استناد به این الزامات تکمیل کند. در صورت بروز تغییر، ابتدا RTM به‌روز شده، سپس نسخهٔ جدید این سند منتشر و در مخزن Git ثبت می‌شود.

