# Change Control & Revert Strategy

این راهنما برای مدیریت تغییرات ناخواسته، بازگشت به نسخه سالم و ثبت اقدام‌ها تدوین شده است.

## 1. اصول پایه
- هر مرحله روی شاخه‌ی مستقل (`feature/<stage-id>/<description>`) انجام می‌شود.
- قبل از شروع مرحله جدید، شاخه با `main` همگام و عاری از تغییرات محلی است.
- Commitها باید کوچک، هدفمند و دارای پیام واضح باشند (فرمت: `<Stage-ID>: <شرح>`).

## 2. ایجاد Snapshot سالم
- پس از تکمیل هر مرحله و قبل از ادغام، یک تگ سبک با نام `baseline/<Stage-ID>/<date>` روی شاخه `main` ایجاد کنید:
  ```bash
  git checkout main
  git pull origin main
  git tag baseline/M13/2025-10-22
  git push origin baseline/M13/2025-10-22
  ```
- این برچسب‌ها مرجع بازگشت در صورت بروز مشکل هستند.

## 3. بازگردانی تغییرات ناخواسته (در شاخه کاری)
1. وضعیت فعلی را بررسی کنید:
   ```bash
   git status
   ```
2. فایل‌های ناخواسته را به حالت آخرین Commit برگردانید:
   ```bash
   git checkout -- <path/to/file>
   ```
3. اگر چندین فایل اشتباه شده‌اند و هنوز Commit نشده‌اند:
   ```bash
   git reset --hard
   ```
4. اگر Commit اشتباهی ثبت شده است، از `git revert <commit>` (برای لغو‌های امن) استفاده کنید و Commit اصلاحی بسازید.
5. پس از بازگشت موفق، نتیجه را در Assumptions یا چک‌لیست مرحله مستند کنید.

## 4. بازگشت به Snapshot سالم (هنگام خرابی گسترده)
1. شاخه‌ای که قرار است اصلاح شود را مشخص کنید.
2. اگر لازم است به تگ سالم برگردید:
   ```bash
   git checkout main
   git reset --hard baseline/M13/2025-10-22
   git push --force-with-lease origin main
   ```
   *استفاده از `--force-with-lease` فقط با هماهنگی مدیر پروژه انجام شود.*
3. پس از بازگشت، مجدداً تغییرات صحیح را اعمال و تست کنید.

## 5. مستندسازی و گزارش
- هر عمل Revert یا Reset باید در فرم `artefacts/stage_completion_checklist.md` (بخش Lessons Learned) ثبت شود.
- در صورت وقوع خطا یا تغییر بزرگ، یک ADR کوتاه با عنوان «Change Control - <موضوع>» ثبت کنید تا ریشه و اقدام اصلاحی مشخص شود.

## 6. خودکارسازی (اختیاری)
- می‌توان از Git Hooks برای جلوگیری از Commit بدون پیام استاندارد یا عدم اجرای تست قبل از push استفاده کرد. در صورت فعال‌سازی، مستند مربوطه باید به مخزن اضافه شود.
