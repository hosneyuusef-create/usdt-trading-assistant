# Evidence Specification – Stage 16

## هدف
تعریف ساختار و الزامات فنی مدارک اثبات تسویه (Fiat/USDT) برای تضمین قابلیت رهگیری، عدم نگهداری دارایی (Non-custodial) و امکان پاسخ‌گویی به اختلافات.

## ساختار داده
| فیلد | توضیح | نمونه |
|------|-------|--------|
| `hash` | هش SHA-256 محتوای رسید یا فایل (حداقل 16 کاراکتر) | `5e88489...` |
| `issuer` | صادرکننده رسید (بانک، صرافی، کیف پول) | `Bank Melli` |
| `payer` | پرداخت‌کننده وجه | `Customer-123` |
| `payee` | دریافت‌کننده وجه | `Provider-456` |
| `amounts.fiat` | مبلغ تراکنش ریالی (IRR) | `2_000_000` |
| `amounts.usdt` | مقدار USDT جابجا شده | `2000` |
| `txId` | شناسه تراکنش کریپتو یا مرجع بانکی | `TX987654321` |
| `network` | شبکه انتقال (TRC20، BEP20، ERC20 و …) | `TRC20` |
| `claimedConfirmations` | تعداد کانفرمیشن‌های اعلام‌شده (≥0) | `12` |
| `metadata` | اطلاعات اختیاری (JSON) | `{ "note": "swift copy" }` |
| `file_name` | نام فایل ضمیمه | `receipt.pdf` |
| `file_size_mb` | اندازه فایل بر حسب MB (≤5) | `1.2` |

## الزامات
- **حداکثر حجم فایل:** 5 مگابایت؛ فایل‌های بزرگ‌تر پس از دو تلاش ناموفق منجر به Escalation می‌شوند.
- **نگهداری:** مدارک باید حداقل 180 روز در فضای امن ذخیره شوند؛ مسیر نگهداری در سیستم فایل یا آبجکت استوریج ثبت می‌شود.
- **غیر حضانتی:** سیستم فقط هش و متادیتا ذخیره می‌کند؛ فایل اصلی باید در مخزن امن مشتری/پرووایدر باقی بماند.

## گردش تسویه
1. آغاز تسویه بر اساس Award → ایجاد دو پایا (Fiat/USDT) برای هر برنده.
2. پرووایدر رسید هر پا را با ساختار فوق آپلود می‌کند.
3. تیم عملیات هریک از مدارک را تایید یا رد می‌کند:
   - رد مدارک یا ارسال ناقص پس از دو تلاش → وضعیت Leg = `escalated` و رویداد در `logs/dispute_events.json` ثبت می‌شود.
4. در صورت سپری شدن Deadline هر پا بدون آپلود معتبر، فرآیند Automate Escalation فعال می‌شود.

## لاگ و ممیزی
- `logs/settlement_events.json`: ثبت رویدادهای آغاز، بارگذاری، تایید و Escalation.
- `logs/dispute_events.json`: ثبت Escalation برای استفاده در مرحله اختلاف (Stage 18).

## مدیریت خطا
- تلاش ناموفق: وضعیت Leg به `pending` باقی می‌ماند و فرصت آپلود مجدد داده می‌شود.
- تلاش دوم ناموفق یا رد عملیات: وضعیت Leg → `escalated`، Settlement → `disputed`، Escalation به Dispute.
