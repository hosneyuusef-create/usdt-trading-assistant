asyncapi: '2.6.0'
info:
  title: USDT Auction Telegram Webhook
  version: 1.0.0
  description: |
    Async webhook specification for Telegram updates processed by the USDT Auction Bot.
    Webhook endpoint enforces HMAC signature, idempotency key and rate limiting (100 req/min per bot token).
servers:
  production:
    url: https://bot.usdt-auction.prod/webhook
    protocol: https
    description: Production webhook endpoint (Windows Native)
    security:
      - webhookSignature: []
channels:
  telegramUpdate:
    subscribe:
      operationId: handleTelegramUpdate
      summary: Telegram Update
      description: Consumes Telegram Bot API update payloads with idempotency enforcement.
      traits:
        - $ref: '#/components/operationTraits/idempotent'
      message:
        name: TelegramUpdate
        title: Telegram Update
        contentType: application/json
        payload:
          $ref: '#/components/schemas/TelegramUpdate'
components:
  securitySchemes:
    webhookSignature:
      type: httpApiKey
      in: header
      name: X-Signature-SHA256
  operationTraits:
    idempotent:
      bindings:
        http:
          headers:
            X-Idempotency-Key:
              type: string
              description: Unique per update to ensure exactly-once processing
          bindingVersion: '0.1.0'
  schemas:
    TelegramUpdate:
      type: object
      required: [update_id, message]
      properties:
        update_id:
          type: integer
        message:
          type: object
          required: [message_id, date, chat]
          properties:
            message_id:
              type: integer
            date:
              type: integer
              description: Unix time
            chat:
              type: object
              required: [id, type]
              properties:
                id:
                  type: integer
                type:
                  type: string
                title:
                  type: string
                username:
                  type: string
            from:
              type: object
              properties:
                id:
                  type: integer
                is_bot:
                  type: boolean
                first_name:
                  type: string
                username:
                  type: string
            text:
              type: string
            entities:
              type: array
              items:
                type: object
                properties:
                  type:
                    type: string
                  offset:
                    type: integer
                  length:
                    type: integer
            reply_to_message:
              $ref: '#/components/schemas/MessageBase'
        callback_query:
          type: object
          properties:
            id:
              type: string
            from:
              $ref: '#/components/schemas/User'
            data:
              type: string
        inline_query:
          type: object
          properties:
            id:
              type: string
            query:
              type: string
    MessageBase:
      type: object
      properties:
        message_id:
          type: integer
        chat:
          type: object
          properties:
            id:
              type: integer
            type:
              type: string
    User:
      type: object
      properties:
        id:
          type: integer
        is_bot:
          type: boolean
        first_name:
          type: string
        username:
          type: string
